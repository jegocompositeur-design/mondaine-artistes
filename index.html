<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Intranet Artistes Mondaine - Gestion de planning et bibliothÃ¨que audio.">
    <meta name="theme-color" content="#1a0b2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>MONDAINE ARTISTES | Intranet</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¤</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700;900&display=swap');

        :root { --primary: #d946ef; --dark: #050505; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Montserrat', sans-serif; background: radial-gradient(circle at top left, #1a0b2e 0%, #050505 100%); color: #e5e5e5; -webkit-font-smoothing: antialiased; }
        h1, h2, h3, .font-serif { font-family: 'Playfair Display', serif; }
        
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f0f13; }
        ::-webkit-scrollbar-thumb { background: #4a1d96; border-radius: 10px; }

        .nav-item.active { border-left-color: #d946ef; background: linear-gradient(90deg, rgba(217, 70, 239, 0.1), transparent); color: #d946ef; }
        .sidebar-collapsed { width: 5rem !important; }
        .sidebar-collapsed .nav-text, .sidebar-collapsed .logo-text { display: none !important; }
        
        @media (max-width: 1024px) {
            .sticky-col {
                position: sticky;
                left: 0;
                z-index: 30;
                background-color: #0a0a0c;
                box-shadow: 4px 0 15px rgba(0,0,0,0.5);
                border-right: 1px solid rgba(255,255,255,0.1);
            }
        }
        .row-active.sticky-col { z-index: 45 !important; background-color: #1a0b2e !important; }

        .planning-cell { transition: all 0.2s; border-color: rgba(255,255,255,0.05); }
        .artist-pill { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .artist-pill.selected { box-shadow: 0 0 20px rgba(255,255,255,0.3); transform: scale(1.02); z-index: 10; border: 1px solid rgba(255,255,255,0.8); }

        .cell-highlight { box-shadow: 0 0 25px rgba(255, 255, 255, 0.5) !important; border: 2px solid white !important; z-index: 50 !important; transform: scale(1.05) !important; }
        .cell-dimmed { opacity: 0.15 !important; filter: grayscale(100%) blur(1px) !important; pointer-events: none; }
        
        /* HALO PRONONCÃ‰ SUR TOUTE LA LIGNE */
        .row-active { 
            box-shadow: inset 0 0 0 2px #ffffff, 0 0 30px rgba(255, 255, 255, 0.6) !important; 
            z-index: 40; 
            border-color: #ffffff !important;
        }

        .month-char { color: #ffffff; line-height: 0.85; font-weight: 900; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .month-sidebar { background: linear-gradient(180deg, #d946ef 0%, #7e22ce 100%); box-shadow: 5px 0 30px rgba(0,0,0,0.6); }

        .glass-panel { background: rgba(10, 5, 20, 0.7); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.05); }

        .track-item { transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .track-item.active { background: linear-gradient(90deg, rgba(217, 70, 239, 0.15) 0%, transparent 100%); border-left: 3px solid #d946ef; color: #f0abfc; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #d946ef; cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px #d946ef; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; cursor: pointer; background: rgba(255,255,255,0.2); }

        .speed-btn { font-size: 9px; font-weight: 700; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); color: #9ca3af; }
        .speed-btn.active-speed { background: rgba(217, 70, 239, 0.3); color: #f0abfc; border-color: #d946ef; }

        #loading-overlay { position: fixed; inset: 0; background: #050505; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .upload-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; color: #9ca3af; }
        .upload-success { background: rgba(22, 163, 74, 0.8) !important; color: white !important; }
        
        .color-bubble { width: 1.25rem; height: 1.25rem; border-radius: 9999px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .color-bubble:hover { transform: scale(1.3); border-color: white; }
        .color-bubble.selected { transform: scale(1.3); border-color: white; box-shadow: 0 0 10px white; }
        .color-bubble.disabled { opacity: 0.1; pointer-events: none; cursor: not-allowed; filter: grayscale(1); }

        .setlist-editor { background: rgba(0,0,0,0.5); border: 1px solid rgba(217, 70, 239, 0.3); color: white; width: 100%; border-radius: 1rem; padding: 1rem; font-family: inherit; font-size: 0.75rem; line-height: 1.5; resize: none; overflow: hidden; outline: none; transition: border-color 0.3s; }
        .setlist-editor:focus { border-color: #d946ef; box-shadow: 0 0 15px rgba(217, 70, 239, 0.2); }

        .date-badge { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 8px; font-weight: 700; color: #eee; white-space: nowrap; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm md:text-base selection:bg-fuchsia-500 selection:text-white">

    <div id="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-fuchsia-500 mb-4 shadow-[0_0_15px_#d946ef]"></div>
            <p class="text-white font-serif tracking-[0.3em] text-xs animate-pulse uppercase">Mondaine Artistes</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTiIaFghO0asxaxp_jtfkUGZj3sSC9ipM",
            authDomain: "mondaine-artistes.firebaseapp.com",
            projectId: "mondaine-artistes",
            storageBucket: "mondaine-artistes.firebasestorage.app",
            messagingSenderId: "490049497488",
            appId: "1:490049497488:web:80f210d3e70689bbdbeb15"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'mondaine-prod';

        window.db = db; window.auth = auth; window.appId = appId; window.storage = storage;
        window.collection = collection; window.doc = doc; window.setDoc = setDoc; window.deleteDoc = deleteDoc; window.onSnapshot = onSnapshot;
        window.storageRef = ref; window.uploadBytesResumable = uploadBytesResumable; window.getDownloadURL = getDownloadURL;

        onAuthStateChanged(auth, (user) => {
            if (user) window.initRealtimeData();
            else signInAnonymously(auth);
        });
    </script>

    <aside id="main-sidebar" class="w-20 md:w-64 bg-black/80 backdrop-blur-xl border-r border-white/5 flex flex-col z-50 shrink-0 transition-all duration-300">
        <div class="p-4 md:p-8 text-center">
            <div class="w-10 h-10 md:w-16 md:h-16 bg-gradient-to-br from-gray-900 to-black rounded-full mx-auto flex items-center justify-center mb-3 border border-purple-500/30">
                <i class="fas fa-microphone-alt text-xl md:text-2xl text-fuchsia-500"></i>
            </div>
            <h2 class="hidden md:block logo-text text-[10px] tracking-[0.2em] uppercase text-purple-300 font-bold">ON AIR</h2>
        </div>
        
        <nav class="flex-1 mt-6 relative">
            <ul class="space-y-2">
                <li><a href="#" onclick="showPage('home')" id="nav-home" class="nav-item active flex items-center justify-center md:justify-start px-2 md:px-8 py-4 text-gray-400 hover:text-white border-l-4 border-transparent transition-all"><i class="fas fa-home w-5"></i><span class="hidden md:inline nav-text ml-4 font-bold text-xs">ACCUEIL</span></a></li>
                <li><a href="#" onclick="showPage('planning')" id="nav-planning" class="nav-item flex items-center justify-center md:justify-start px-2 md:px-8 py-4 text-gray-400 hover:text-white border-l-4 border-transparent transition-all"><i class="far fa-calendar-alt w-5"></i><span class="hidden md:inline nav-text ml-4 font-bold text-xs">PLANNING</span></a></li>
                <li><a href="#" onclick="showPage('setlist')" id="nav-setlist" class="nav-item flex items-center justify-center md:justify-start px-2 md:px-8 py-4 text-gray-400 hover:text-white border-l-4 border-transparent transition-all"><i class="fas fa-music w-5"></i><span class="hidden md:inline nav-text ml-4 font-bold text-xs">SETLISTE</span></a></li>
                <li><a href="#" onclick="showPage('audio')" id="nav-audio" class="nav-item flex items-center justify-center md:justify-start px-2 md:px-8 py-4 text-gray-400 hover:text-white border-l-4 border-transparent transition-all"><i class="fas fa-headphones w-5"></i><span class="hidden md:inline nav-text ml-4 font-bold text-xs">AUDIO</span></a></li>
                <li id="admin-nav-item" class="hidden mt-8 border-t border-white/5 pt-4">
                    <a href="#" onclick="showPage('admin-panel')" id="nav-admin-panel" class="nav-item flex items-center justify-center md:justify-start px-2 md:px-8 py-4 text-red-400 border-l-4 border-transparent"><i class="fas fa-cogs w-5"></i><span class="hidden md:inline nav-text ml-4 font-bold text-xs">ADMIN</span></a>
                </li>
            </ul>
        </nav>

        <div class="p-4 border-t border-white/5 text-center">
             <button onclick="toggleSidebar()" class="mb-4 text-gray-500 hover:text-white w-full flex items-center justify-center"><i id="sidebar-icon" class="fas fa-compress-alt text-lg"></i></button>
             <button onclick="toggleAdminMode()" id="admin-toggle-btn" class="text-gray-500 hover:text-fuchsia-400 w-full flex items-center justify-center py-4"><i class="fas fa-lock"></i></button>
        </div>
    </aside>

    <main class="flex-1 relative overflow-hidden bg-[#050505]">
        <!-- ACCUEIL -->
        <section id="home" class="page-section h-full w-full absolute inset-0 z-10 overflow-y-auto">
            <div class="min-h-full w-full flex flex-col justify-center items-center text-center p-4 relative" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(5,5,5,0.95)), url('https://images.unsplash.com/photo-1514525253440-b393452e8d26?q=80&w=2000&auto=format&fit=crop'); background-size: cover; background-position: center;">
                <div class="border border-white/10 p-8 md:p-16 backdrop-blur-md bg-black/60 fade-in rounded-sm mb-8">
                    <h1 class="text-5xl md:text-8xl font-black text-white tracking-tighter mb-2">MONDAINE</h1>
                    <h2 class="text-2xl md:text-3xl text-fuchsia-500 tracking-[0.6em] font-light">ARTISTES</h2>
                </div>
                <div id="home-news-container" class="w-full max-w-2xl space-y-4 fade-in hidden z-20"></div>
            </div>
        </section>

        <!-- PLANNING -->
        <section id="planning" class="page-section h-full w-full absolute inset-0 hidden flex flex-col fade-in bg-[#0a0a0c]">
            <header class="flex justify-between items-center p-6 border-b border-white/5 bg-black/40 backdrop-blur-sm shrink-0">
                <h2 class="text-3xl text-white font-black uppercase tracking-tighter">Planning</h2>
                <div class="flex items-center gap-2 bg-white/5 rounded-full px-4 py-1.5 border border-white/10">
                    <button onclick="changeMonth(-1)" class="p-1 hover:text-fuchsia-400"><i class="fas fa-chevron-left"></i></button>
                    <span id="current-month-display" class="w-32 text-center font-bold text-xs uppercase tracking-widest text-white">CHARGEMENT</span>
                    <button onclick="changeMonth(1)" class="p-1 hover:text-fuchsia-400"><i class="fas fa-chevron-right"></i></button>
                </div>
            </header>
            <div class="flex flex-1 overflow-hidden">
                <div class="flex-1 overflow-auto" id="planning-scroll-container">
                    <div class="flex" id="planning-container"></div>
                    <div id="artist-mobile-content" class="lg:hidden p-6 grid grid-cols-2 gap-2 pb-24 bg-black/40 border-t border-white/5"></div>
                </div>
                <aside class="w-48 md:w-60 bg-[#08080a] border-l border-white/5 p-5 overflow-y-auto hidden lg:block shadow-2xl z-20 backdrop-blur-md">
                     <h3 class="text-gray-500 text-[10px] font-bold uppercase tracking-[0.2em] mb-6 text-center border-b border-white/5 pb-2">Effectifs</h3>
                     <div id="artist-sidebar-content"></div>
                </aside>
            </div>
        </section>

        <!-- SETLISTE -->
        <section id="setlist" class="page-section h-full w-full absolute inset-0 hidden overflow-y-auto p-4 md:p-10 bg-[#0b0b10]">
            <div class="flex items-center justify-between mb-8 pt-2 border-b border-white/5 pb-4">
                <h2 class="text-4xl md:text-6xl font-black text-white uppercase tracking-tighter">Set <span class="text-fuchsia-600">Liste</span></h2>
                <div id="admin-setlist-controls" class="hidden">
                    <span class="text-[10px] font-bold text-fuchsia-400 animate-pulse">MODE Ã‰DITION ACTIF</span>
                </div>
            </div>
            <div id="setlist-public-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 pb-20"></div>
        </section>

        <!-- AUDIO -->
        <section id="audio" class="page-section h-full w-full absolute inset-0 hidden overflow-hidden bg-[#080510]">
            <div class="flex h-full flex-col md:flex-row">
                <div class="flex-1 flex flex-col p-4 md:p-8 overflow-hidden order-2 md:order-1">
                    <h2 class="hidden md:block text-3xl font-black text-white mb-6 uppercase tracking-tighter">AUDIO <span class="text-fuchsia-600">PLAYER</span></h2>
                    <div class="mb-4 md:mb-6 relative">
                        <input type="text" id="audio-search" placeholder="RECHERCHER..." class="w-full bg-white/5 border border-white/10 rounded-full py-3 md:py-4 pl-12 pr-6 text-white text-sm font-bold focus:border-fuchsia-500 outline-none uppercase tracking-wider">
                        <i class="fas fa-search absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                    </div>
                    <div class="flex-1 overflow-y-auto pr-2 pb-24 md:pb-0" id="audio-track-list"></div>
                </div>

                <div class="h-auto md:h-full w-full md:w-[480px] glass-panel flex flex-col p-4 md:p-8 border-b md:border-b-0 md:border-l border-white/10 z-20 order-1 md:order-2 shadow-2xl transition-all duration-300">
                    <div id="player-empty-state" class="flex flex-col items-center justify-center h-32 md:h-full text-center opacity-40">
                        <i class="fas fa-headphones text-3xl md:text-5xl text-fuchsia-500 mb-2"></i>
                        <p class="text-[10px] md:text-xs font-bold uppercase tracking-widest text-gray-400">SÃ©lectionnez un titre</p>
                    </div>
                    <div id="player-content" class="hidden flex flex-col h-full">
                        <h3 id="player-title" class="text-xl md:text-3xl font-black text-white uppercase mb-4 md:mb-8 leading-tight break-words">TITRE</h3>
                        <div class="bg-black/40 rounded-2xl md:rounded-3xl p-5 md:p-8 mb-6 border border-white/5 shadow-inner">
                            <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-6">
                                <div class="flex gap-2" id="speed-controls">
                                    <button onclick="setSpeed(0.5)" class="speed-btn px-3 py-1.5">0.5</button>
                                    <button onclick="setSpeed(1.0)" class="speed-btn px-3 py-1.5 active-speed">1.0</button>
                                    <button onclick="setSpeed(1.5)" class="speed-btn px-3 py-1.5">1.5</button>
                                </div>
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-volume-up text-xs text-gray-500"></i>
                                    <input type="range" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)" class="w-24">
                                </div>
                            </div>
                            <div class="flex justify-center items-center gap-8 mb-8">
                                <button onclick="stopAudio()" class="text-gray-500 hover:text-white transition-colors text-lg"><i class="fas fa-stop"></i></button>
                                <button onclick="togglePlay()" id="play-btn" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-gradient-to-br from-fuchsia-600 to-purple-700 text-white flex items-center justify-center shadow-[0_0_30px_rgba(217,70,239,0.4)] hover:scale-105 transition-transform"><i class="fas fa-play ml-1 text-2xl md:text-3xl"></i></button>
                                <button onclick="resetAudio()" class="text-gray-500 hover:text-white transition-colors text-lg"><i class="fas fa-redo-alt"></i></button>
                            </div>
                            <audio id="audio-element" ontimeupdate="updateProgress()" onended="resetPlayerUI()"></audio>
                            <div class="w-full bg-gray-800 h-2 rounded-full mb-3 cursor-pointer" onclick="seekAudio(event)">
                                <div id="progress-bar" class="bg-fuchsia-500 h-full w-0 rounded-full shadow-[0_0_10px_#d946ef]"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 font-mono">
                                <span id="time-current">00:00</span>
                                <span id="time-total">00:00</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <a id="btn-lyrics" href="#" target="_blank" class="flex flex-col items-center justify-center p-4 bg-blue-900/20 border border-blue-500/20 rounded-2xl opacity-50 text-[10px] md:text-xs font-bold uppercase transition-all hover:bg-blue-900/30">
                                <i class="fas fa-align-center mb-2 text-blue-400 text-lg"></i><span>Paroles</span>
                            </a>
                            <a id="btn-sheet" href="#" target="_blank" class="flex flex-col items-center justify-center p-4 bg-orange-900/20 border border-orange-500/20 rounded-2xl opacity-50 text-[10px] md:text-xs font-bold uppercase transition-all hover:bg-orange-900/30">
                                <i class="fas fa-music mb-2 text-orange-400 text-lg"></i><span>Partition</span>
                            </a>
                        </div>
                        <a id="btn-youtube" href="#" target="_blank" class="w-full flex items-center justify-center gap-3 p-4 bg-red-900/20 border border-red-500/20 rounded-2xl opacity-50 text-[10px] md:text-xs font-bold uppercase transition-all hover:bg-red-900/30">
                            <i class="fab fa-youtube text-red-500 text-2xl"></i><span>VidÃ©o / ChorÃ©</span>
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- ADMIN -->
        <section id="admin-panel" class="page-section h-full w-full absolute inset-0 hidden overflow-y-auto p-6 md:p-10 bg-[#0f0a18]">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 border-b border-white/10 pb-6 gap-4">
                <h2 class="text-3xl font-black text-white uppercase tracking-tighter"><i class="fas fa-cogs text-fuchsia-600 mr-3"></i>Administration</h2>
            </header>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
                <div class="lg:col-span-5 bg-white/5 p-6 rounded-2xl border border-white/5">
                    <h3 class="text-fuchsia-400 font-bold uppercase mb-6 text-sm flex items-center gap-2">
                        <i class="fas fa-users"></i> Gestion de l'Ã©quipe
                    </h3>
                    <div class="bg-black/40 p-4 rounded-xl mb-6 border border-white/5">
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input type="text" id="new-artist-name" placeholder="NOM" class="bg-black/40 p-2 rounded text-white uppercase text-xs border border-white/10 outline-none focus:border-fuchsia-500">
                            <select id="new-artist-role" onchange="updateColorPicker()" class="bg-black/40 p-2 rounded text-white uppercase text-xs border border-white/10 outline-none focus:border-fuchsia-500">
                                <option value="chant">CHANT</option>
                                <option value="piano">PIANO</option>
                                <option value="basse">BASSE</option>
                                <option value="drum">DRUM</option>
                            </select>
                        </div>
                        <div class="mb-2 text-[9px] uppercase font-bold text-gray-500">Choisissez une couleur disponible :</div>
                        <div id="new-artist-color-picker" class="flex flex-wrap gap-2 mb-4 p-1 bg-black/20 rounded-lg max-h-40 overflow-y-auto"></div>
                        <input type="hidden" id="selected-color-value">
                        <button onclick="addNewArtist()" class="w-full bg-gradient-to-r from-fuchsia-700 to-purple-700 py-3 rounded text-white font-bold uppercase text-xs transition-all">Ajouter l'artiste</button>
                    </div>
                    <div id="admin-team-list" class="space-y-4 max-h-[400px] overflow-y-auto pr-2"></div>
                </div>

                <div class="lg:col-span-7 bg-white/5 p-6 rounded-2xl border border-white/5">
                    <h3 class="text-fuchsia-400 font-bold uppercase mb-6 text-sm flex items-center gap-2">
                        <i class="fas fa-headphones"></i> BibliothÃ¨que Audio & Fichiers
                    </h3>
                    <div class="bg-black/40 p-6 rounded-xl border border-white/5">
                        <input type="hidden" id="audio-id-input">
                        <input type="text" id="audio-title-input" placeholder="TITRE DU MORCEAU" class="w-full bg-white/5 p-3 rounded mb-4 text-white font-bold uppercase text-sm border border-white/10 outline-none focus:border-fuchsia-500">
                        
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <button onclick="document.getElementById('upload-input-audio').click()" id="upload-btn-audio" class="upload-btn group">
                                <i class="fas fa-music mb-2 text-fuchsia-500 group-hover:text-white"></i><span>Audio</span>
                            </button>
                            <button onclick="document.getElementById('upload-input-lyrics').click()" id="upload-btn-lyrics" class="upload-btn group">
                                <i class="fas fa-align-center mb-2 text-blue-500 group-hover:text-white"></i><span>Paroles</span>
                            </button>
                            <button onclick="document.getElementById('upload-input-sheet').click()" id="upload-btn-sheet" class="upload-btn group">
                                <i class="fas fa-scroll mb-2 text-orange-500 group-hover:text-white"></i><span>Partit.</span>
                            </button>
                        </div>

                        <input type="file" id="upload-input-audio" class="hidden" accept="audio/*" onchange="uploadSingleFile(this, 'mp3', 'upload-btn-audio', 'audio-src-input')">
                        <input type="file" id="upload-input-lyrics" class="hidden" accept=".pdf" onchange="uploadSingleFile(this, 'lyrics', 'upload-btn-lyrics', 'audio-lyrics-input')">
                        <input type="file" id="upload-input-sheet" class="hidden" accept=".pdf" onchange="uploadSingleFile(this, 'sheet', 'upload-btn-sheet', 'audio-sheet-input')">
                        
                        <input type="hidden" id="audio-src-input">
                        <input type="hidden" id="audio-lyrics-input">
                        <input type="hidden" id="audio-sheet-input">

                        <div class="relative mb-4">
                             <i class="fab fa-youtube absolute left-3 top-1/2 -translate-y-1/2 text-red-500"></i>
                             <input type="text" id="audio-youtube-input" placeholder="Lien VidÃ©o / YouTube" class="w-full bg-white/5 pl-10 pr-3 py-2 rounded text-white text-xs border border-white/10 outline-none focus:border-fuchsia-500">
                        </div>

                        <div class="flex items-center gap-3 mb-6 bg-fuchsia-900/20 p-3 rounded-lg border border-fuchsia-500/20">
                            <input type="checkbox" id="audio-is-new" class="w-4 h-4 accent-fuchsia-500">
                            <label for="audio-is-new" class="text-xs font-bold uppercase text-white cursor-pointer">NouveautÃ© / Ã€ travailler</label>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="saveAudioTrack()" class="flex-1 bg-gradient-to-r from-fuchsia-700 to-purple-700 py-3 rounded text-white font-bold uppercase text-xs shadow-lg">Sauvegarder</button>
                            <button onclick="clearAudioForm()" class="px-4 bg-gray-800 rounded text-white font-bold uppercase text-xs">Reset</button>
                        </div>
                    </div>
                    <div class="mt-4 bg-black/30 rounded-xl border border-white/5 p-4 overflow-hidden flex flex-col h-[400px]">
                        <div id="admin-audio-list" class="space-y-1 overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="toast-notification" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-green-600/90 backdrop-blur-md text-white px-8 py-3 rounded-full shadow-lg z-[100] opacity-0 font-bold text-xs uppercase transition-all pointer-events-none flex items-center gap-3">
        <i class="fas fa-check-circle text-lg"></i> <span id="toast-msg">EnregistrÃ©</span>
    </div>

    <div id="password-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-[#1a0b2e] border border-fuchsia-500/30 rounded-2xl p-8 w-full max-w-sm text-center">
            <h3 class="text-white font-black text-xl mb-6 uppercase">Admin Mondaine</h3>
            <input type="password" id="admin-pass-input" class="w-full bg-black/50 border border-white/10 rounded p-3 text-center text-white mb-4 focus:border-fuchsia-500 outline-none" placeholder="â€¢â€¢â€¢â€¢">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeModal('password-modal')" class="py-3 border border-gray-700 text-gray-400 rounded-lg text-xs font-bold uppercase">Annuler</button>
                <button onclick="checkAdminPassword()" class="py-3 bg-fuchsia-600 text-white rounded-lg text-xs font-bold uppercase">OK</button>
            </div>
        </div>
    </div>

    <div id="assign-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#1a0b2e] border border-fuchsia-500/30 rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-white font-bold uppercase text-xs mb-4 text-center border-b border-white/10 pb-2" id="modal-slot-info">Date</h3>
            <div id="modal-artist-list" class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto pr-1"></div>
            <button onclick="removeAssignment()" class="w-full mt-4 py-3 border border-red-500/30 text-red-400 rounded-lg text-xs font-bold uppercase">Retirer l'artiste</button>
        </div>
    </div>

    <script>
        let ARTISTS = [];
        let assignments = {};
        let SETLISTS = { wed: { date: "MER", content: "" }, thu: { date: "JEU", content: "" }, fri: { date: "VEN", content: "" }, sat: { date: "SAM", content: "" } };
        let AUDIO_LIBRARY = [];
        let currentDate = new Date(); 
        let selectedArtistId = null;
        let highlightedRow = null;
        let currentEditSlot = null;
        let isAdminMode = false;
        let currentTrack = null;
        let lastPlayStart = 0;

        const PUBLIC_DOC = (col, id) => window.doc(window.db, 'artifacts', window.appId, 'public', 'data', col, id);

        const PALETTES = {
            chant: [
                // Ultra Fluo / Flash (12)
                'bg-yellow-300', 'bg-lime-400', 'bg-cyan-300', 'bg-fuchsia-400', 'bg-rose-400', 'bg-green-300', 
                'bg-orange-400', 'bg-blue-300', 'bg-pink-400', 'bg-indigo-300', 'bg-emerald-300', 'bg-violet-400',
                // Pastels (12)
                'bg-fuchsia-100', 'bg-pink-100', 'bg-rose-100', 'bg-purple-100', 'bg-violet-100', 'bg-indigo-100',
                'bg-fuchsia-200', 'bg-pink-200', 'bg-rose-200', 'bg-purple-200', 'bg-violet-200', 'bg-indigo-200'
            ],
            piano: [
                'bg-green-500', 'bg-emerald-500', 'bg-teal-500', 'bg-lime-500', 'bg-green-300', 'bg-emerald-300', 'bg-teal-300',
                'bg-stone-500', 'bg-stone-700', 'bg-stone-400', 'bg-stone-300', 'bg-stone-600', 'bg-orange-950', 'bg-yellow-950',
                'bg-gray-500', 'bg-gray-400', 'bg-slate-400', 'bg-slate-600', 'bg-zinc-500', 'bg-neutral-600'
            ],
            basse: [
                'bg-blue-500', 'bg-blue-400', 'bg-sky-500', 'bg-sky-400', 'bg-cyan-500', 'bg-blue-700', 'bg-cyan-700',
                'bg-purple-600', 'bg-purple-500', 'bg-purple-400', 'bg-violet-500', 'bg-violet-400', 'bg-indigo-700', 'bg-indigo-400',
                'bg-pink-500', 'bg-pink-400', 'bg-fuchsia-500', 'bg-rose-500', 'bg-rose-400', 'bg-pink-600'
            ],
            drum: [
                'bg-yellow-500', 'bg-yellow-400', 'bg-amber-500', 'bg-amber-400', 'bg-yellow-600', 'bg-amber-600', 'bg-yellow-300',
                'bg-red-500', 'bg-red-600', 'bg-red-400', 'bg-rose-600', 'bg-rose-700', 'bg-red-700', 'bg-red-300',
                'bg-orange-500', 'bg-orange-400', 'bg-orange-600', 'bg-orange-300', 'bg-orange-700', 'bg-amber-700'
            ]
        };

        function showToast(msg) {
            const t = document.getElementById('toast-notification');
            if(msg) document.getElementById('toast-msg').innerText = msg;
            t.classList.add('opacity-100');
            setTimeout(() => t.classList.remove('opacity-100'), 3000);
        }

        window.uploadSingleFile = function(input, type, btnId, targetId) {
            const file = input.files[0]; if (!file) return;
            const btn = document.getElementById(btnId);
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            btn.classList.add('opacity-50');

            const path = `artifacts/${window.appId}/public/audio/${type}/${Date.now()}_${file.name.replace(/\s/g, '_')}`;
            const ref = window.storageRef(window.storage, path);
            const task = window.uploadBytesResumable(ref, file);

            task.on('state_changed', null, (e) => { 
                console.error(e);
                btn.innerHTML = "ERR"; 
                btn.classList.remove('opacity-50');
            }, () => {
                window.getDownloadURL(task.snapshot.ref).then(url => {
                    document.getElementById(targetId).value = url;
                    btn.classList.remove('opacity-50');
                    btn.classList.add('upload-success');
                    btn.innerHTML = `<i class="fas fa-check"></i>`;
                });
            });
        };

        function renderArtistList(roleId) {
            const artists = ARTISTS.filter(a => a.role === roleId);
            return artists.map(a => {
                const isSelected = selectedArtistId === a.id;
                
                let datesHTML = '';
                if(isSelected) {
                    const artistDates = [...new Set(Object.entries(assignments)
                        .filter(([key, val]) => val === a.id)
                        .map(([key]) => key.split('_')[0]))].sort();
                    
                    if(artistDates.length > 0) {
                        datesHTML = `<div class="flex flex-wrap gap-1 mt-2 px-1 pb-2">
                            ${artistDates.map(dStr => {
                                const dObj = new Date(dStr);
                                const fmt = dObj.toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric', month: 'short'});
                                return `<span class="date-badge">${fmt}</span>`;
                            }).join('')}
                        </div>`;
                    } else {
                        datesHTML = `<div class="text-[8px] text-gray-500 italic mt-1 text-center">Aucune date prÃ©vue</div>`;
                    }
                }

                return `<div class="mb-1">
                    <button onclick="toggleArtistFilter('${a.id}')" class="artist-pill w-full px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center justify-center relative ${a.color} ${isSelected ? 'selected' : 'opacity-80 hover:opacity-100'}">
                        ${a.name}
                        ${isSelected ? '<span class="absolute right-3 w-1.5 h-1.5 bg-white rounded-full animate-pulse"></span>' : ''}
                    </button>
                    ${datesHTML}
                </div>`;
            }).join('');
        }

        function renderPlanning() {
            const container = document.getElementById('planning-container');
            const sidebar = document.getElementById('artist-sidebar-content');
            const mobileContainer = document.getElementById('artist-mobile-content');
            
            const monthName = currentDate.toLocaleDateString('fr-FR', {month: 'long'}).toUpperCase();
            document.getElementById('current-month-display').textContent = `${monthName} ${currentDate.getFullYear()}`;

            let verticalMonthHTML = `<div class="month-sidebar flex flex-col justify-center items-center w-20 md:w-28 shrink-0 mr-4 md:mr-8 rounded-r-3xl border-r border-fuchsia-400/30 hidden md:flex">`;
            for(let char of monthName) { verticalMonthHTML += `<span class="month-char block text-5xl md:text-7xl font-black mb-1 text-center w-full">${char}</span>`; }
            verticalMonthHTML += `</div>`;

            let gridHTML = `<div class="flex-1 overflow-x-auto pb-4"><div class="min-w-[900px] grid grid-cols-[80px_1fr_1fr_1fr_20px_1fr_1fr_1fr] gap-1.5 text-center pb-10 pr-4">
                <div class=""></div><div class="col-span-3 bg-purple-900/40 p-2 rounded-t text-[10px] font-bold uppercase tracking-widest text-purple-200">Chants</div><div class=""></div><div class="col-span-3 bg-blue-900/40 p-2 rounded-t text-[10px] font-bold uppercase tracking-widest text-blue-200">Musiciens</div>
                <div class="sticky-col bg-white/5 text-gray-400 font-bold text-[10px] uppercase py-3 border border-white/5">DATES</div>
                <div class="bg-purple-500/10 text-purple-200 text-[9px] uppercase py-3 border border-white/5">Chant 1</div><div class="bg-purple-500/10 text-purple-200 text-[9px] uppercase py-3 border border-white/5">Chant 2</div><div class="bg-purple-500/10 text-purple-200 text-[9px] uppercase py-3 border border-white/5">Chant 3</div><div class="flex justify-center h-full"><div class="w-px h-full bg-white/10"></div></div>
                <div class="bg-blue-500/10 text-blue-200 text-[9px] uppercase py-3 border border-white/5">Piano</div><div class="bg-blue-500/10 text-blue-200 text-[9px] uppercase py-3 border border-white/5">Basse</div><div class="bg-blue-500/10 text-blue-200 text-[9px] uppercase py-3 border border-white/5">Drum</div>`;

            const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            while(d.getMonth() === currentDate.getMonth()) {
                if([3,4,5,6].includes(d.getDay())) {
                    const dateStr = [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
                    const isSat = d.getDay() === 6;
                    const isRowActive = highlightedRow === dateStr;
                    const dateCellBg = isRowActive ? 'bg-fuchsia-800' : (isSat ? 'bg-[#2a1b3d]' : 'bg-[#1a0b2e]');
                    
                    gridHTML += `<div onclick="toggleRowHighlight('${dateStr}')" class="sticky-col h-16 flex flex-col justify-center items-center border border-white/5 rounded-lg ${dateCellBg} cursor-pointer group ${isRowActive?'row-active':''}">
                        <span class="text-[8px] uppercase text-fuchsia-300 font-bold tracking-wider">${d.toLocaleDateString('fr-FR', {weekday: 'short'})}</span>
                        <span class="text-lg font-black text-white leading-none">${d.getDate()}</span>
                    </div>`;

                    ['chant1', 'chant2', 'chant3', 'sep', 'piano', 'basse', 'drum'].forEach(slot => {
                        if(slot === 'sep') gridHTML += `<div class="flex justify-center h-full"><div class="w-px h-full bg-white/10"></div></div>`;
                        else {
                            const artistId = assignments[`${dateStr}_${slot}`];
                            const artist = ARTISTS.find(a => a.id === artistId);
                            let cellClass = `h-16 border border-white/5 flex items-center justify-center rounded transition-all ${isRowActive?'row-active':''} planning-cell `;
                            let content = '';
                            if(artist) {
                                cellClass += `${artist.color} shadow-lg `;
                                if(selectedArtistId && artist.id === selectedArtistId) cellClass += `cell-highlight `;
                                else if (selectedArtistId && artist.id !== selectedArtistId) cellClass += `cell-dimmed `;
                                content = `<span class="font-bold text-[10px] px-1 truncate pointer-events-none">${artist.name}</span>`;
                            } else {
                                cellClass += `bg-black/20 `;
                                if(selectedArtistId) cellClass += `cell-dimmed `;
                                if(isAdminMode) content = `<i class="fas fa-plus text-white/10"></i>`;
                            }
                            gridHTML += `<div class="${cellClass}" onclick="${isAdminMode?`handleCellClick('${dateStr}','${slot}')`:''}">${content}</div>`;
                        }
                    });
                    if(isSat) gridHTML += `<div class="col-span-8 h-2"></div>`;
                }
                d.setDate(d.getDate() + 1);
            }
            gridHTML += `</div></div>`;
            container.innerHTML = verticalMonthHTML + gridHTML;

            const roles = [
                { id: 'chant', label: 'Chants', icon: 'fa-microphone-alt', color: 'text-fuchsia-400' },
                { id: 'piano', label: 'Piano', icon: 'fa-keyboard', color: 'text-green-400' },
                { id: 'basse', label: 'Basse', icon: 'fa-guitar', color: 'text-blue-400' },
                { id: 'drum', label: 'Batterie', icon: 'fa-drum', color: 'text-red-400' }
            ];

            const sidebarHTML = roles.map(role => `
                <div class="mb-6">
                    <h4 class="text-[9px] font-bold uppercase mb-3 ${role.color} tracking-widest flex items-center gap-2">
                        <i class="fas ${role.icon} text-xs"></i> ${role.label}
                    </h4>
                    <div class="space-y-1">${renderArtistList(role.id)}</div>
                </div>
            `).join('');
            
            if(sidebar) sidebar.innerHTML = sidebarHTML;
            if(mobileContainer) mobileContainer.innerHTML = sidebarHTML;
        }

        window.toggleRowHighlight = (d) => { highlightedRow = (highlightedRow===d)?null:d; renderPlanning(); };
        window.toggleArtistFilter = (id) => { selectedArtistId = (selectedArtistId===id)?null:id; renderPlanning(); };

        function renderAudioList(term='') {
            const list = document.getElementById('audio-track-list');
            const filtered = AUDIO_LIBRARY.filter(t => t.title.toLowerCase().includes(term.toLowerCase())).sort((a,b)=>a.title.localeCompare(b.title));
            list.innerHTML = filtered.map(t => `<button onclick="selectTrack('${t.id}')" class="track-item w-full text-left p-4 text-gray-400 font-bold uppercase flex justify-between items-center ${currentTrack?.id===t.id?'active':''}">
                <span class="truncate pr-4">${t.isNew?'ðŸš¨ ':''}${t.title}</span><i class="fas fa-play text-[10px] shrink-0"></i>
            </button>`).join('');
        }

        window.selectTrack = (id) => {
            currentTrack = AUDIO_LIBRARY.find(t => t.id === id);
            document.getElementById('player-empty-state').classList.add('hidden');
            document.getElementById('player-content').classList.remove('hidden');
            document.getElementById('player-title').innerText = currentTrack.title;
            const a = document.getElementById('audio-element');
            a.src = currentTrack.src || "";
            a.currentTime = 0; lastPlayStart = 0;
            a.play().catch(e => console.log("Auto-play bloquÃ©"));
            document.getElementById('play-btn').querySelector('i').className = "fas fa-pause text-2xl md:text-3xl";
            updateBtn('btn-lyrics', currentTrack.lyrics);
            updateBtn('btn-sheet', currentTrack.sheet);
            updateBtn('btn-youtube', currentTrack.youtube);
            renderAudioList(document.getElementById('audio-search').value);
        };

        function updateBtn(id, link) {
            const b = document.getElementById(id); if(!b) return;
            b.href = link || "#";
            if(link) { b.classList.remove('opacity-50'); b.classList.add('opacity-100'); }
            else { b.classList.remove('opacity-100'); b.classList.add('opacity-50'); }
        }

        window.togglePlay = () => {
            const a = document.getElementById('audio-element'); const i = document.getElementById('play-btn').querySelector('i');
            if(a.paused) { a.play(); i.className = "fas fa-pause text-2xl md:text-3xl"; }
            else { a.pause(); i.className = "fas fa-play text-2xl md:text-3xl ml-1"; }
        };
        window.stopAudio = () => { const a = document.getElementById('audio-element'); a.pause(); a.currentTime = 0; resetPlayerUI(); };
        window.resetAudio = () => { const a = document.getElementById('audio-element'); a.currentTime = 0; a.play(); };
        window.resetPlayerUI = () => { document.getElementById('play-btn').querySelector('i').className = "fas fa-play text-2xl md:text-3xl ml-1"; };
        window.updateProgress = () => {
            const a = document.getElementById('audio-element');
            if(a.duration) {
                document.getElementById('progress-bar').style.width = `${(a.currentTime/a.duration)*100}%`;
                document.getElementById('time-current').innerText = formatTime(a.currentTime);
                document.getElementById('time-total').innerText = formatTime(a.duration);
            }
        };
        function formatTime(s) { const m = Math.floor(s/60); const sc = Math.floor(s%60); return `${m}:${sc.toString().padStart(2,'0')}`; }
        window.seekAudio = (e) => { const a = document.getElementById('audio-element'); a.currentTime = (e.offsetX / e.currentTarget.clientWidth) * a.duration; };
        window.setSpeed = (s) => { document.getElementById('audio-element').playbackRate = s; document.querySelectorAll('.speed-btn').forEach(b => b.classList.toggle('active-speed', parseFloat(b.innerText)===s)); };
        window.setVolume = (v) => { document.getElementById('audio-element').volume = v; };

        window.initRealtimeData = () => {
            onSnapshot(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'artists'), s => { ARTISTS = s.docs.map(d=>d.data()); renderPlanning(); renderAdminTeamList(); if(isAdminMode) updateColorPicker(); });
            onSnapshot(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'planning'), s => { assignments = {}; s.forEach(d=>assignments[d.id]=d.data().artistId); renderPlanning(); });
            onSnapshot(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'audio'), s => { AUDIO_LIBRARY = s.docs.map(d=>d.data()); renderAudioList(); renderAdminAudioList(); renderHomeNews(); });
            onSnapshot(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'setlists'), s => { s.forEach(d=>{if(SETLISTS[d.id]) SETLISTS[d.id]=d.data();}); renderSetlistPublic(); });
            setTimeout(() => document.getElementById('loading-overlay').classList.add('opacity-0', 'pointer-events-none'), 800);
        };

        window.addNewArtist = async () => {
            const name = document.getElementById('new-artist-name').value.toUpperCase().trim();
            const color = document.getElementById('selected-color-value').value;
            const role = document.getElementById('new-artist-role').value;
            if(!name || !color) return;
            const id = Date.now().toString();
            await setDoc(PUBLIC_DOC('artists', id), { id, name, color, role });
            document.getElementById('new-artist-name').value = ''; showToast();
        };

        window.saveAudioTrack = async () => {
            const title = document.getElementById('audio-title-input').value.toUpperCase().trim(); if(!title) return;
            const id = document.getElementById('audio-id-input').value || Date.now().toString();
            await setDoc(PUBLIC_DOC('audio', id), { 
                id, title, 
                isNew: document.getElementById('audio-is-new').checked, 
                src: document.getElementById('audio-src-input').value, 
                lyrics: document.getElementById('audio-lyrics-input').value, 
                sheet: document.getElementById('audio-sheet-input').value, 
                youtube: document.getElementById('audio-youtube-input').value 
            });
            clearAudioForm(); showToast();
        };

        window.renderHomeNews = () => {
            const c = document.getElementById('home-news-container'); const nt = AUDIO_LIBRARY.filter(t => t.isNew);
            if(!nt.length) { c.classList.add('hidden'); return; }
            c.classList.remove('hidden');
            c.innerHTML = `<div class="bg-red-900/80 p-4 rounded-xl border border-red-500/50 shadow-lg animate-pulse">
                <h3 class="text-white font-black text-xs mb-3 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> NOUVEAUTÃ‰ Ã€ TRAVAILLER</h3>
                ${nt.map(t => `<div class="bg-black/40 p-3 rounded-lg flex justify-between items-center mb-2 border border-white/5">
                    <span class="text-white font-bold text-xs">ðŸš¨ ${t.title}</span>
                    <button onclick="playNewsTrack('${t.id}')" class="bg-white text-red-900 px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-md">Ã‰COUTER</button>
                </div>`).join('')}
            </div>`;
        };
        window.playNewsTrack = (id) => { showPage('audio'); setTimeout(() => selectTrack(id), 100); };

        function renderSetlistPublic() {
            const c = document.getElementById('setlist-public-container');
            const d = [{k:'wed',c:'blue'},{k:'thu',c:'purple'},{k:'fri',c:'pink'},{k:'sat',c:'indigo'}];
            
            c.innerHTML = d.map(day => {
                const dayData = SETLISTS[day.k];
                if (isAdminMode) {
                    return `<div class="bg-${day.c}-900/10 border border-${day.c}-500/30 rounded-3xl overflow-hidden flex flex-col h-full shadow-2xl">
                        <input type="text" id="edit-date-${day.k}" value="${dayData.date}" class="bg-${day.c}-600 p-4 text-center text-white font-black uppercase tracking-widest text-sm outline-none border-none">
                        <div class="p-6 flex-1">
                            <textarea id="edit-content-${day.k}" 
                                class="setlist-editor" 
                                placeholder="Entrez la liste ici..." 
                                oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'">${dayData.content || ""}</textarea>
                        </div>
                        <button onclick="saveSetlistInline('${day.k}')" class="m-3 p-3 bg-green-600 hover:bg-green-500 rounded-xl text-[10px] uppercase font-bold text-white transition-all flex items-center justify-center gap-2 shadow-lg"><i class="fas fa-save"></i> Enregistrer</button>
                    </div>`;
                } else {
                    return `<div class="bg-${day.c}-900/10 border border-${day.c}-500/30 rounded-3xl overflow-hidden flex flex-col h-full shadow-2xl">
                        <div class="bg-${day.c}-600 p-4 text-center text-white font-black uppercase tracking-widest text-sm">${dayData.date}</div>
                        <div class="p-6 text-xs text-gray-200 flex-1 whitespace-pre-wrap font-medium">${dayData.content || "Aucune liste..."}</div>
                        <button onclick="copySet('${day.k}')" class="m-3 p-3 bg-white/5 hover:bg-white/10 rounded-xl text-[10px] uppercase font-bold text-gray-400 transition-all flex items-center justify-center gap-2"><i class="fas fa-copy"></i> Copier</button>
                    </div>`;
                }
            }).join('');

            if(isAdminMode) {
                setTimeout(() => {
                    d.forEach(day => {
                        const el = document.getElementById(`edit-content-${day.k}`);
                        if(el) el.style.height = el.scrollHeight + 'px';
                    });
                }, 100);
            }
        }

        window.saveSetlistInline = async (k) => {
            const dateVal = document.getElementById('edit-date-'+k).value;
            const contentVal = document.getElementById('edit-content-'+k).value;
            SETLISTS[k] = { date: dateVal, content: contentVal };
            await setDoc(PUBLIC_DOC('setlists', k), SETLISTS[k]);
            showToast("Setlist " + dateVal + " enregistrÃ©e");
        };

        window.copySet = (id) => { navigator.clipboard.writeText(SETLISTS[id].content); showToast("Setlist copiÃ©e !"); };

        window.showPage = (id) => {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.id==='nav-'+id));
            if(id === 'admin-panel') loadAdminValues();
            if(id === 'setlist') renderSetlistPublic();
        };

        function loadAdminValues() {
            renderAdminTeamList();
            renderAdminAudioList();
            updateColorPicker();
        }

        window.toggleSidebar = () => { document.getElementById('main-sidebar').classList.toggle('sidebar-collapsed'); };
        window.toggleAdminMode = () => { 
            if(isAdminMode) { 
                isAdminMode=false; 
                document.getElementById('admin-setlist-controls').classList.add('hidden');
                updateAdminUI(); 
            } else document.getElementById('password-modal').classList.remove('hidden'); 
        };
        window.checkAdminPassword = () => { 
            if(document.getElementById('admin-pass-input').value==='mondaine') { 
                isAdminMode=true; 
                document.getElementById('admin-setlist-controls').classList.remove('hidden');
                updateAdminUI(); 
                closeModal('password-modal'); 
            } 
        };
        window.updateAdminUI = () => { 
            document.getElementById('admin-nav-item').classList.toggle('hidden', !isAdminMode); 
            renderPlanning(); 
            renderSetlistPublic();
        };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.handleCellClick = (d, s) => { currentEditSlot = {dateStr:d, slot:s}; renderModalArtists(); document.getElementById('assign-modal').classList.remove('hidden'); };
        
        function renderModalArtists() {
            document.getElementById('modal-artist-list').innerHTML = ARTISTS.map(a => `<button onclick="setAssign('${a.id}')" class="${a.color} p-3 rounded font-bold text-[10px] uppercase shadow-md">${a.name}</button>`).join('');
        }
        window.setAssign = async (id) => { await setDoc(PUBLIC_DOC('planning', `${currentEditSlot.dateStr}_${currentEditSlot.slot}`), { artistId: id }); closeModal('assign-modal'); };
        window.removeAssignment = async () => { await deleteDoc(PUBLIC_DOC('planning', `${currentEditSlot.dateStr}_${currentEditSlot.slot}`)); closeModal('assign-modal'); };

        function clearAudioForm() {
            document.querySelectorAll('#admin-panel input').forEach(i => { if(i.type!=='hidden'&&i.type!=='checkbox') i.value=''; });
            document.getElementById('audio-id-input').value=''; 
            document.getElementById('audio-is-new').checked=false;
        }
        
        function renderAdminAudioList() {
            const sorted = [...AUDIO_LIBRARY].sort((a,b) => a.title.localeCompare(b.title));
            document.getElementById('admin-audio-list').innerHTML = sorted.map(t => `<div class="bg-white/5 p-2 rounded flex justify-between items-center mb-1 group hover:bg-white/10 transition-all border border-white/5"><span class="text-[10px] font-bold text-white uppercase">${t.title}</span><div class="flex gap-1 opacity-50 group-hover:opacity-100"><button onclick="editAudio('${t.id}')" class="text-blue-400 p-1"><i class="fas fa-edit"></i></button><button onclick="deleteAudio('${t.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div>`).join('');
        }

        function renderAdminTeamList() {
             const container = document.getElementById('admin-team-list');
             if(!container) return;
             const categories = [
                { id: 'chant', label: 'CHANT' },
                { id: 'piano', label: 'PIANO' },
                { id: 'basse', label: 'BASSE' },
                { id: 'drum', label: 'DRUM' }
            ];
            container.innerHTML = categories.map(cat => {
                const catArtists = ARTISTS.filter(a => a.role === cat.id);
                return `<div class="mb-4">
                    <h4 class="text-[10px] font-black uppercase mb-2 text-white/50 border-b border-white/5 pb-1">${cat.label}</h4>
                    <div class="grid grid-cols-2 gap-2">
                        ${catArtists.map(a => `<div class="flex justify-between items-center bg-black/30 p-2 rounded border border-white/5 group">
                            <span class="text-[10px] font-bold ${a.color} px-2 py-1 rounded">${a.name}</span>
                            <button onclick="deleteArtist('${a.id}')" class="text-gray-600 hover:text-red-500 p-1"><i class="fas fa-times"></i></button>
                        </div>`).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        window.deleteArtist = async (id) => { if(confirm("Supprimer l'artiste ?")) await deleteDoc(PUBLIC_DOC('artists', id)); };
        window.editAudio = (id) => { const t = AUDIO_LIBRARY.find(a=>a.id===id); document.getElementById('audio-id-input').value=t.id; document.getElementById('audio-title-input').value=t.title; document.getElementById('audio-is-new').checked=t.isNew; document.getElementById('audio-src-input').value=t.src; };
        window.deleteAudio = async (id) => { if(confirm("Supprimer ?")) await deleteDoc(PUBLIC_DOC('audio', id)); };

        window.updateColorPicker = () => {
            const role = document.getElementById('new-artist-role').value;
            const palette = PALETTES[role];
            const usedColors = ARTISTS.filter(a => a.role === role).map(a => a.color.split(' ')[0]);
            
            const container = document.getElementById('new-artist-color-picker');
            container.innerHTML = palette.map(c => {
                const isUsed = usedColors.includes(c);
                return `<div class="color-bubble ${c} ${isUsed ? 'disabled' : ''}" onclick="selectColor(this,'${c}')"></div>`;
            }).join('');
            
            const firstAvailable = palette.find(c => !usedColors.includes(c));
            if(firstAvailable) {
                const firstEl = Array.from(container.children).find(el => el.classList.contains(firstAvailable));
                selectColor(firstEl, firstAvailable);
            }
        }
        
        window.selectColor = (el, c) => { 
            if(!el || el.classList.contains('disabled')) return;
            
            let textColor = 'text-white';
            if(c.includes('100') || c.includes('200') || c.includes('300') || c.includes('yellow') || c.includes('lime') || c.includes('cyan')) {
                textColor = 'text-black';
            }
            
            document.getElementById('selected-color-value').value = `${c} ${textColor}`; 
            document.querySelectorAll('.color-bubble').forEach(d=>d.classList.remove('selected'));
            el.classList.add('selected');
        };

        window.onload = () => { 
            showPage('home'); 
            updateColorPicker(); 
            document.getElementById('audio-search').addEventListener('input', (e) => renderAudioList(e.target.value));
            window.addEventListener('beforeunload', (e)=>{e.preventDefault(); e.returnValue='';}); 
        };
    </script>
</body>
</html>
